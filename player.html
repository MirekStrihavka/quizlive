<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>QuizLive ‚Äì Hr√°ƒç</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#09090f;--bg2:#0e0e17;--bg3:#13131f;--bg4:#1a1a28;
  --gold:#c9a84c;--gold2:#e8c97a;--gold3:#f5e0a0;
  --border:rgba(201,168,76,.12);--border2:rgba(201,168,76,.25);--border3:rgba(201,168,76,.45);
  --text:#eeeef5;--text2:#b8b8cc;--muted:#6a6a88;
  --danger:#e05555;--success:#4ecb8d;--r:12px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Jost',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;justify-content:center}
body::after{content:'';position:fixed;inset:0;pointer-events:none;
  background:radial-gradient(ellipse 60% 40% at 50% 20%,rgba(201,168,76,.07) 0%,transparent 65%)}
.wrap{width:100%;max-width:440px;padding:20px;display:flex;flex-direction:column;gap:0;height:100%;overflow-y:auto}
.wrap::-webkit-scrollbar{display:none}

/* JOIN */
#scr-join{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;height:100%;padding:20px}
.join-logo{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;color:var(--gold2);letter-spacing:2px}
.join-sub{font-size:.85rem;color:var(--muted);text-align:center}
.join-card{width:100%;max-width:340px;background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:28px 24px;display:flex;flex-direction:column;gap:14px}
.field label{display:block;font-size:.68rem;font-weight:600;color:var(--muted);margin-bottom:5px;letter-spacing:.5px;text-transform:uppercase}
input{width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'Jost',sans-serif;font-size:1rem;padding:11px 14px;outline:none;transition:border-color .15s;text-align:center;letter-spacing:2px}
input:focus{border-color:var(--gold)}
.btn-join{width:100%;padding:14px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:10px;font-family:'Jost',sans-serif;font-size:1rem;font-weight:600;color:var(--bg);cursor:pointer;transition:all .2s}
.btn-join:hover{filter:brightness(1.1)}
.btn-join:disabled{opacity:.4;cursor:not-allowed}
.err{color:var(--danger);font-size:.82rem;text-align:center;display:none}
.err.show{display:block}

/* WAIT */
#scr-wait{display:none;flex-direction:column;align-items:center;justify-content:center;gap:18px;height:100%;text-align:center}
.wait-name{font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:700;color:var(--gold2)}
.wait-sub{font-size:.9rem;color:var(--muted)}
.wait-dot{width:8px;height:8px;border-radius:50%;background:var(--gold);animation:wdot 1.2s ease-in-out infinite}
@keyframes wdot{0%,100%{transform:scale(1);opacity:.4}50%{transform:scale(1.5);opacity:1}}

/* QUESTION */
#scr-q{display:none;flex-direction:column;gap:16px;padding-top:20px;padding-bottom:20px}
.q-meta{font-size:.72rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.q-text{font-family:'Cormorant Garamond',serif;font-size:1.75rem;font-weight:700;line-height:1.2;color:var(--text)}
.timer-row{display:flex;align-items:center;gap:10px}
.t-num{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;color:var(--gold2);min-width:40px}
.t-num.manual{font-size:.9rem;color:var(--muted);font-family:'Jost',sans-serif;letter-spacing:.5px}
.tbar-wrap{flex:1;height:4px;background:var(--bg4);border-radius:2px}
.tbar{height:100%;background:var(--gold);border-radius:2px;transition:width 1s linear}
.opts{display:flex;flex-direction:column;gap:10px}
.opt-btn{width:100%;padding:14px 18px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);display:flex;align-items:center;gap:13px;cursor:pointer;transition:all .2s;font-family:'Jost',sans-serif;font-size:.95rem;color:var(--text2);text-align:left}
.opt-btn:hover:not(:disabled){border-color:var(--border2);transform:translateX(3px)}
.opt-btn:disabled{cursor:not-allowed}
.opt-btn.selected{border-color:var(--gold2);background:rgba(201,168,76,.12);color:var(--text)}
.opt-btn.correct{border-color:var(--success);background:rgba(78,203,141,.12);color:var(--success)}
.opt-btn.wrong{border-color:var(--danger);background:rgba(224,85,85,.08);opacity:.6}
.obadge{width:32px;height:32px;border-radius:7px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;border:1px solid var(--border2);background:var(--bg3);color:var(--muted)}
.opt-btn.selected .obadge{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold2)}
.opt-btn.correct .obadge{background:var(--success);border-color:var(--success);color:var(--bg)}
.opt-btn.wrong .obadge{background:rgba(224,85,85,.2);border-color:var(--danger);color:var(--danger)}
.ans-badge{padding:13px 16px;border-radius:10px;font-size:.9rem;font-weight:500;text-align:center;display:none}
.ans-badge.show{display:block}
.ans-badge.ok{background:rgba(78,203,141,.12);border:1px solid rgba(78,203,141,.3);color:var(--success)}
.ans-badge.nok{background:rgba(224,85,85,.08);border:1px solid rgba(224,85,85,.25);color:var(--danger)}
.ans-badge.wait{background:rgba(201,168,76,.08);border:1px solid var(--border);color:var(--muted)}
.locked-banner{background:rgba(201,168,76,.08);border:1px solid var(--border2);border-radius:10px;padding:12px 16px;text-align:center;font-size:.87rem;color:var(--muted);display:none}
.locked-banner.show{display:block}

/* INTER RESULT */
#scr-inter{display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;height:100%;text-align:center}
.inter-icon{font-size:3.5rem}
.inter-msg{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;transition:color .3s}
.inter-sub{font-size:.82rem;color:var(--muted)}

/* RESULTS */
#scr-res{display:none;flex-direction:column;gap:16px;padding-top:20px;padding-bottom:20px}
.res-title{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;color:var(--gold2);text-align:center}
.score-big{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:24px;text-align:center;display:flex;flex-direction:column;gap:4px}
.score-num{font-family:'Cormorant Garamond',serif;font-size:4rem;font-weight:700;color:var(--gold2);line-height:1}
.score-sub{font-size:.85rem;color:var(--muted)}
.lb-title{font-size:.67rem;font-weight:600;letter-spacing:1.8px;text-transform:uppercase;color:var(--gold)}
.lbr{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:11px 14px}
.lbr.me{border-color:var(--gold2);background:rgba(201,168,76,.07)}
.lbrank{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:700;color:var(--muted);min-width:24px}
.lbrank.top{color:var(--gold2)}
.lbname{flex:1;font-size:.88rem}
.lbscore{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:700;color:var(--success)}
</style>
</head>
<body>
<div class="wrap">
  <!-- JOIN -->
  <div id="scr-join">
    <div class="join-logo">‚óÜ QuizLive</div>
    <div class="join-sub">P≈ôipoj se k ≈æiv√©mu kv√≠zu</div>
    <div class="join-card">
      <div class="field">
        <label>K√≥d m√≠stnosti</label>
        <input id="inp-code" placeholder="XXXX" maxlength="6" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">
      </div>
      <div class="field">
        <label>Tvoje jm√©no</label>
        <input id="inp-name" placeholder="Jm√©no" style="letter-spacing:0;text-align:left" maxlength="30">
      </div>
      <div class="err" id="err-msg"></div>
      <button class="btn-join" onclick="joinQuiz()">P≈ôipojit se ‚Üí</button>
    </div>
  </div>

  <!-- WAIT -->
  <div id="scr-wait">
    <div class="wait-name" id="wait-name">Ahoj!</div>
    <div class="wait-sub">ƒåek√°me na start kv√≠zu‚Ä¶</div>
    <div class="wait-dot"></div>
  </div>

  <!-- QUESTION -->
  <div id="scr-q">
    <div class="q-meta" id="q-meta">Ot√°zka 1 / 5</div>
    <div class="q-text" id="q-text">‚Ä¶</div>
    <div class="timer-row">
      <div class="t-num" id="t-num">30</div>
      <div class="tbar-wrap"><div class="tbar" id="t-bar" style="width:100%"></div></div>
    </div>
    <div class="locked-banner" id="locked-banner">üîí Odpov√≠d√°n√≠ bylo uzav≈ôeno</div>
    <div class="opts" id="opts"></div>
    <div class="ans-badge" id="ans-badge"></div>
  </div>

  <!-- INTER -->
  <div id="scr-inter">
    <div class="inter-icon" id="inter-icon">‚è≥</div>
    <div class="inter-msg" id="inter-msg">Spr√°vnƒõ!</div>
    <div id="inter-detail" style="display:none;width:100%;max-width:340px;background:var(--bg2);border-radius:14px;padding:14px 18px;margin-top:4px;text-align:left">
      <div style="font-size:.68rem;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px">V√Ωsledek ot√°zky</div>
      <div id="inter-q-text" style="font-size:.82rem;color:var(--text2);margin-bottom:10px;line-height:1.45"></div>
      <div id="inter-my-ans" style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.82rem"></div>
      <div id="inter-ok-ans" style="display:flex;align-items:center;gap:8px;font-size:.82rem"></div>
    </div>
    <div class="inter-sub" id="inter-sub" style="margin-top:8px">ƒåek√°me na dal≈°√≠ ot√°zku‚Ä¶</div>
  </div>

  <!-- RESULTS -->
  <div id="scr-res">
    <div class="res-title">‚óÜ V√Ωsledky</div>
    <div class="score-big">
      <div class="score-num" id="my-score">0</div>
      <div class="score-sub" id="my-score-sub">spr√°vn√Ωch odpovƒõd√≠</div>
    </div>
    <div class="lb-title">Po≈ôad√≠</div>
    <div id="lb-list"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBZsk77K9aRF-LHbLZdgrVhI4rEARykdaQ",
  authDomain: "quizlive-f87c1.firebaseapp.com",
  databaseURL: "https://quizlive-f87c1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "quizlive-f87c1",
  storageBucket: "quizlive-f87c1.firebasestorage.app",
  messagingSenderId: "343853762884",
  appId: "1:343853762884:web:e9e1fa3d462f4514b7af11"
};

const app = initializeApp(FIREBASE_CONFIG);
const db = getDatabase(app);

const OPTS=['A','B','C','D'];
let myName='', myCode='', playerKey='';
let myAnswers={}, myScore=0;
let lastQ=-1, lastTS=0;
let answered=false, timerInt=null, pollInt=null;
let interShownQ=-1;

// Pre-fill code from URL
const urlCode=new URLSearchParams(location.search).get('code');
if(urlCode){ document.getElementById('inp-code').value=urlCode.toUpperCase(); }

function dbRef(path){ return ref(db, path.replace(/:/g,'/')); }
async function dbGet(path){ try{ const s=await get(dbRef(path)); return s.exists()?s.val():null; }catch(e){ return null; } }
async function dbSet(path,val){ try{ await set(dbRef(path),val); }catch(e){ console.error(e); } }

function showErr(msg){ const e=document.getElementById('err-msg'); e.textContent=msg; e.classList.add('show'); }
function showScr(n){ ['join','wait','q','inter','res'].forEach(s=>{ document.getElementById('scr-'+s).style.display=s===n?'flex':'none'; }); }

window.joinQuiz = async () => {
  const code = document.getElementById('inp-code').value.trim().toUpperCase();
  const name = document.getElementById('inp-name').value.trim();
  if(code.length<4||!name){ showErr('Vypl≈à k√≥d i jm√©no.'); return; }

  const ses = await dbGet('session/'+code);
  if(!ses || ses.phase==='results'){ showErr('M√≠stnost nenalezena nebo kv√≠z skonƒçil.'); return; }

  myName=name; myCode=code;
  const slug = name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  playerKey = 'player/'+code+'/'+slug+'_'+Date.now();

  await dbSet(playerKey, {name:myName, code:myCode, joinedAt:Date.now(), answers:{}, score:0});

  document.getElementById('wait-name').textContent='Ahoj, '+myName+'!';
  showScr('wait');
  pollInt = setInterval(poll, 1500);
};

async function savePlayer(){
  await dbSet(playerKey, {name:myName, code:myCode, joinedAt:Date.now(), answers:myAnswers, score:myScore});
}

async function poll(){
  const ses = await dbGet('session/'+myCode);
  if(!ses) return;

  if(ses.phase==='lobby'){ showScr('wait'); return; }

  if(ses.phase==='results'){
    clearInterval(pollInt);
    await showResults();
    return;
  }

  if(ses.phase==='question'||ses.phase==='revealed'){
    const q=ses.currentQ;
    const ts=ses.ts||0;
    const locked=!ses.answersOpen;

    // Show locked banner
    document.getElementById('locked-banner').classList.toggle('show', locked && !answered);

    // Show inter-result screen when answer is revealed and we answered
    if(ses.phase==='revealed' && answered && interShownQ!==q){
      interShownQ=q;
      showInterResult(q, ses.question);
      return;
    }

    // New question - but wait at least 4s after inter screen was shown
    if(q!==lastQ || ts!==lastTS){
      if(_interShownAt && Date.now()-_interShownAt < 4000){
        // Still within min display time - keep inter screen a bit longer
        setTimeout(()=>{ _interShownAt=0; }, 4200-( Date.now()-_interShownAt));
        return;
      }
      lastQ=q; lastTS=ts;
      answered = myAnswers[q]!==undefined;
      interShownQ=-1;
      _interShownAt=0;
      renderQ(ses, q, locked);
      return;
    }

    // Update lock state on current question
    if(locked && !answered){
      document.querySelectorAll('.opt-btn').forEach(b=>b.disabled=true);
    }
  }
}

function renderQ(ses, qi, locked){
  const q=ses.question;
  if(!q) return;
  clearInterval(timerInt);
  showScr('q');
  document.getElementById('q-meta').textContent='Ot√°zka '+(qi+1)+' / '+ses.questionCount;
  document.getElementById('q-text').textContent=q.text;
  document.getElementById('ans-badge').className='ans-badge';
  document.getElementById('locked-banner').classList.toggle('show', locked && !answered);

  document.getElementById('opts').innerHTML=q.options.map((o,i)=>`
    <button class="opt-btn${answered&&myAnswers[qi]===i?' selected':''}" id="ob-${i}" onclick="chooseOpt(${qi},${i},${q.correct})" ${answered||locked?'disabled':''}>
      <div class="obadge">${OPTS[i]}</div>${o}
    </button>`).join('');

  if(answered){
    const myA=myAnswers[qi];
    showFeedback(myA, q.correct, ses.phase==='revealed');
  }

  // Timer
  if(q.time && !locked){
    const tn=document.getElementById('t-num');
    tn.className='t-num';
    tn.textContent=q.time;
    document.getElementById('t-bar').style.width='100%';
    let left=q.time; const max=q.time;
    timerInt=setInterval(()=>{
      left--;
      tn.textContent=left;
      document.getElementById('t-bar').style.width=(left/max*100)+'%';
      if(left<=0){ clearInterval(timerInt); }
    },1000);
  } else if(!q.time) {
    const tn=document.getElementById('t-num');
    tn.className='t-num manual';
    tn.textContent='Ruƒçn√≠';
    document.getElementById('t-bar').style.width='100%';
  } else {
    // locked
    clearInterval(timerInt);
    document.getElementById('t-num').textContent='‚úï';
    document.getElementById('t-bar').style.width='0';
  }
}

window.chooseOpt = async (qi, choice, correct) => {
  if(answered) return;
  answered=true;
  myAnswers[qi]=choice;
  if(choice===correct) myScore++;
  await savePlayer();

  document.querySelectorAll('.opt-btn').forEach(b=>b.disabled=true);
  document.getElementById('locked-banner').classList.remove('show');

  const ses = await dbGet('session/'+myCode);
  showFeedback(choice, correct, ses && ses.phase==='revealed');
};

function showFeedback(choice, correct, revealed){
  const ok = choice===correct;
  document.querySelectorAll('.opt-btn').forEach((b,i)=>{
    b.classList.remove('selected','correct','wrong');
    if(revealed){
      if(i===correct) b.classList.add('correct');
      else if(i===choice && !ok) b.classList.add('wrong');
    } else {
      if(i===choice) b.classList.add('selected');
    }
  });
  const badge=document.getElementById('ans-badge');
  if(revealed){
    badge.className='ans-badge show '+(ok?'ok':'nok');
    badge.textContent=ok?'‚úì Spr√°vnƒõ!':'‚úó ≈†patnƒõ';
  } else {
    badge.className='ans-badge show wait';
    badge.textContent='‚úì Odpovƒõƒè ulo≈æena ‚Äì ƒçek√°me na v√Ωsledek';
  }
}

let _interShownAt=0;

function showInterResult(qi, q){
  if(!q) return;
  const ok = myAnswers[qi]===q.correct;
  const myA = myAnswers[qi];
  const BCOLS=['#4e8cff','#e05c5c','#2ac878','#f5a623'];

  // Icon + main message
  document.getElementById('inter-icon').textContent=ok?'‚úÖ':'‚ùå';
  const msgEl=document.getElementById('inter-msg');
  msgEl.textContent=ok?'Spr√°vnƒõ!':'≈†patnƒõ';
  msgEl.style.color=ok?'var(--success)':'#e07070';

  // Detail panel
  const detail=document.getElementById('inter-detail');
  if(detail){
    detail.style.display='block';
    detail.style.borderTop='3px solid '+(ok?'var(--success)':'#e07070');

    const qText=document.getElementById('inter-q-text');
    if(qText) qText.textContent=q.text||'';

    const myAnsEl=document.getElementById('inter-my-ans');
    if(myAnsEl){
      const myOptText=q.options&&q.options[myA]!=null?q.options[myA]:'‚Äì';
      myAnsEl.innerHTML=`<span style="font-size:.7rem;color:var(--muted);min-width:70px">Tv√° odpovƒõƒè:</span>
        <span style="padding:2px 10px;border-radius:12px;background:${ok?'rgba(42,200,120,.15)':'rgba(220,80,80,.15)'};color:${ok?'var(--success)':'#e07070'};font-weight:600">
          ${OPTS[myA]||'?'}: ${esc(myOptText)}
        </span>`;
    }

    const okAnsEl=document.getElementById('inter-ok-ans');
    if(okAnsEl){
      if(!ok){
        const okOptText=q.options&&q.options[q.correct]!=null?q.options[q.correct]:'‚Äì';
        okAnsEl.innerHTML=`<span style="font-size:.7rem;color:var(--muted);min-width:70px">Spr√°vnƒõ bylo:</span>
          <span style="padding:2px 10px;border-radius:12px;background:rgba(42,200,120,.15);color:var(--success);font-weight:600">
            ${OPTS[q.correct]||'?'}: ${esc(okOptText)}
          </span>`;
        okAnsEl.style.display='flex';
      } else {
        okAnsEl.style.display='none';
      }
    }
  }

  document.getElementById('inter-sub').textContent='ƒåek√°me na dal≈°√≠ ot√°zku‚Ä¶';
  _interShownAt=Date.now();
  showScr('inter');
}

async function showResults(){
  showScr('res');
  const total = (await dbGet('session/'+myCode+'/questionCount')) || 0;
  document.getElementById('my-score').textContent=myScore;
  document.getElementById('my-score-sub').textContent='z '+total+' ot√°zek ('+Math.round(myScore/(total||1)*100)+'%)';

  // Get all players
  const snap = await dbGet('player/'+myCode);
  if(!snap) return;
  const players=[];
  Object.values(snap).forEach(p=>{ if(p&&p.name) players.push(p); });
  players.sort((a,b)=>(b.score||0)-(a.score||0));

  document.getElementById('lb-list').innerHTML=players.map((p,i)=>`
    <div class="lbr${p.name===myName?' me':''}">
      <div class="lbrank${i<3?' top':''}">${i+1}</div>
      <div class="lbname">${esc(p.name)}${p.name===myName?' (ty)':''}</div>
      <div class="lbscore">${p.score||0}</div>
    </div>`).join('');
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
</script>
</body>
</html>
