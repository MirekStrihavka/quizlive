<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>QuizLive ‚Äì Hr√°ƒç</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#09090f;--bg2:#0e0e17;--bg3:#13131f;--bg4:#1a1a28;
  --gold:#c9a84c;--gold2:#e8c97a;--gold3:#f5e0a0;
  --border:rgba(201,168,76,.12);--border2:rgba(201,168,76,.25);--border3:rgba(201,168,76,.45);
  --text:#eeeef5;--text2:#b8b8cc;--muted:#6a6a88;
  --danger:#e05555;--success:#4ecb8d;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Jost',sans-serif;overflow:hidden}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 55% 35% at 85% 5%,rgba(201,168,76,.06) 0%,transparent 65%),
             radial-gradient(ellipse 45% 55% at 5% 95%,rgba(201,168,76,.04) 0%,transparent 65%)}

.scr{display:none;flex-direction:column;height:100%;position:relative;z-index:1;padding:env(safe-area-inset-top,0) 0 env(safe-area-inset-bottom,0)}
.scr.active{display:flex}

/* ‚îÄ‚îÄ JOIN ‚îÄ‚îÄ */
#s-join{align-items:center;justify-content:center;gap:28px;padding:28px 24px;
  background:radial-gradient(ellipse 70% 40% at 50% 20%,rgba(201,168,76,.07) 0%,transparent 70%),var(--bg)}
.join-logo{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:700;color:var(--gold2);
  display:flex;align-items:center;gap:10px;letter-spacing:1px}
.join-logo::before{content:'‚óÜ';font-size:1.1rem;color:var(--gold)}
.join-tagline{font-size:.85rem;color:var(--muted);letter-spacing:.3px}
.join-card{width:100%;max-width:360px;background:var(--bg2);border:1px solid var(--border2);border-radius:20px;padding:28px 22px;display:flex;flex-direction:column;gap:18px}
.field-lbl{font-size:.68rem;font-weight:600;color:var(--muted);margin-bottom:6px;letter-spacing:.5px;text-transform:uppercase}
input[type=text]{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--border2);border-radius:11px;color:var(--text);font-family:'Jost',sans-serif;font-size:1rem;padding:13px 16px;outline:none;transition:border-color .2s}
input[type=text]:focus{border-color:var(--gold)}
.code-inp{font-family:'Cormorant Garamond',serif;font-size:2rem;letter-spacing:8px;text-align:center;text-transform:uppercase;font-weight:700}
.btn-join{width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:11px;font-family:'Jost',sans-serif;font-size:1.05rem;font-weight:600;color:var(--bg);cursor:pointer;transition:all .2s;-webkit-appearance:none}
.btn-join:active{transform:scale(.97);filter:brightness(.95)}
.join-err{color:var(--danger);font-size:.82rem;text-align:center;display:none}

/* ‚îÄ‚îÄ WAITING ‚îÄ‚îÄ */
#s-wait{align-items:center;justify-content:center;gap:24px;padding:32px 24px;text-align:center}
.wait-diamond{font-size:3.5rem;animation:bob 2s ease-in-out infinite}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
.wait-title{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;line-height:1.2}
.wait-name{color:var(--gold2)}
.wait-dots{display:flex;gap:7px;justify-content:center}
.wait-dots span{width:7px;height:7px;border-radius:50%;background:var(--muted);animation:dp 1.4s infinite}
.wait-dots span:nth-child(2){animation-delay:.2s}
.wait-dots span:nth-child(3){animation-delay:.4s}
@keyframes dp{0%,100%{opacity:.3}50%{opacity:1}}
.wait-sub{color:var(--muted);font-size:.88rem}

/* ‚îÄ‚îÄ QUESTION ‚îÄ‚îÄ */
#s-q{flex-direction:column;overflow:hidden}
.q-topbar{padding:14px 18px 10px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0;display:flex;align-items:center;gap:12px}
.q-num-lbl{font-size:.72rem;color:var(--muted);font-weight:600;letter-spacing:.5px}
.q-tbar-wrap{flex:1;height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.q-tbar{height:100%;background:var(--gold);border-radius:2px;transition:width 1s linear}
.q-timer-face{font-family:'Cormorant Garamond',serif;font-size:1.7rem;font-weight:700;color:var(--gold2);min-width:40px;text-align:right;line-height:1}
.q-timer-face.manual{font-size:.82rem;color:var(--muted);font-family:'Jost',sans-serif}
.q-body{flex:1;padding:20px 18px 14px;display:flex;flex-direction:column;gap:20px;overflow-y:auto}
.q-body::-webkit-scrollbar{display:none}
.q-text{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:700;line-height:1.3}
.opts{display:flex;flex-direction:column;gap:10px}
.opt{
  display:flex;align-items:center;gap:13px;
  background:var(--bg2);border:2px solid var(--border);border-radius:14px;
  padding:15px 17px;cursor:pointer;transition:all .15s;
  -webkit-tap-highlight-color:transparent;
}
.opt:active{transform:scale(.97)}
.opt.chosen{border-color:var(--gold2);background:rgba(201,168,76,.1)}
.opt.correct{border-color:var(--success)!important;background:rgba(78,203,141,.12)!important}
.opt.wrong{border-color:rgba(224,85,85,.4)!important;background:rgba(224,85,85,.08)!important;opacity:.7}
.opt.locked{cursor:default}
.opt-letter{width:34px;height:34px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;transition:all .15s}
.lA{background:rgba(201,168,76,.2);border:1px solid rgba(201,168,76,.4);color:var(--gold2)}
.lB{background:rgba(78,203,141,.15);border:1px solid rgba(78,203,141,.35);color:var(--success)}
.lC{background:rgba(123,163,255,.15);border:1px solid rgba(123,163,255,.35);color:#7ba3ff}
.lD{background:rgba(224,120,85,.15);border:1px solid rgba(224,120,85,.35);color:#e07855}
.opt.correct .opt-letter{background:var(--success)!important;border-color:var(--success)!important;color:var(--bg)!important}
.opt.wrong .opt-letter{background:rgba(224,85,85,.25)!important;border-color:var(--danger)!important;color:var(--danger)!important}
.opt-txt{font-size:.95rem;line-height:1.3}

/* closed banner */
.closed-banner{background:rgba(201,168,76,.08);border:1px solid var(--border2);border-radius:11px;padding:11px 15px;font-size:.84rem;color:var(--muted);text-align:center;display:none}
.closed-banner.show{display:block}

/* ‚îÄ‚îÄ INTER-RESULT ‚îÄ‚îÄ */
#s-res{align-items:center;justify-content:center;gap:20px;padding:28px 22px;text-align:center;overflow-y:auto}
#s-res::-webkit-scrollbar{display:none}
.res-icon{font-size:4.5rem;animation:popIn .4s cubic-bezier(.175,.885,.32,1.275)}
@keyframes popIn{from{transform:scale(0)}to{transform:scale(1)}}
.res-msg{font-family:'Cormorant Garamond',serif;font-size:2.4rem;font-weight:700}
.res-ans-box{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:13px;padding:14px 20px;max-width:360px}
.res-ans-lbl{font-size:.7rem;color:var(--muted);margin-bottom:3px;letter-spacing:.5px;text-transform:uppercase}
.res-ans-val{font-size:.95rem;font-weight:600}
.res-stats{display:flex;gap:10px;width:100%;max-width:360px}
.rstat{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:13px;padding:14px;text-align:center}
.rstat-val{font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:700}
.rstat-val.g{color:var(--success)}.rstat-val.r{color:var(--danger)}
.rstat-lbl{font-size:.7rem;color:var(--muted);margin-top:2px}
.wait-next{color:var(--muted);font-size:.82rem}

/* ‚îÄ‚îÄ FINAL ‚îÄ‚îÄ */
#s-final{padding:22px 18px;gap:16px;overflow-y:auto}
#s-final::-webkit-scrollbar{display:none}
.final-hdr{text-align:center;padding:16px 0}
.final-medal{font-size:2.2rem}
.final-rank{font-family:'Cormorant Garamond',serif;font-size:4.5rem;font-weight:700;color:var(--gold2);line-height:1}
.final-name{font-size:1.2rem;font-weight:600;margin-top:4px}
.final-score{color:var(--muted);font-size:.9rem;margin-top:3px}
.lb-title{font-size:.68rem;font-weight:600;letter-spacing:1.8px;text-transform:uppercase;color:var(--gold)}
.lb{display:flex;flex-direction:column;gap:6px}
.lbr{display:flex;align-items:center;gap:11px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:11px 14px}
.lbr.me{border-color:var(--gold2);background:rgba(201,168,76,.07)}
.lbrank{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:700;color:var(--muted);min-width:24px}
.lbrank.top{color:var(--gold2)}
.lbname{flex:1;font-size:.88rem}
.lbscore{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:700;color:var(--success)}

@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.anim{animation:fadeUp .4s ease}
</style>
</head>
<body>

<!-- JOIN -->
<div class="scr active" id="s-join">
  <div class="join-logo">QuizLive</div>
  <div class="join-tagline">P≈ôipoj se ke kv√≠zu</div>
  <div class="join-card">
    <div>
      <div class="field-lbl">K√≥d m√≠stnosti</div>
      <input type="text" class="code-inp" id="inp-code" maxlength="4" placeholder="XXXX" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <div>
      <div class="field-lbl">Tvoje jm√©no</div>
      <input type="text" id="inp-name" maxlength="24" placeholder="Jak se jmenuje≈°?" autocomplete="off">
    </div>
    <button class="btn-join" onclick="joinQuiz()">P≈ôipojit se ‚Üí</button>
    <div class="join-err" id="j-err">Nespr√°vn√Ω k√≥d nebo chyb√≠ jm√©no.</div>
  </div>
</div>

<!-- WAITING -->
<div class="scr" id="s-wait">
  <div class="wait-diamond">‚óÜ</div>
  <div class="wait-title">P≈ôipraveno!<br><span class="wait-name" id="w-name"></span></div>
  <div class="wait-dots"><span></span><span></span><span></span></div>
  <div class="wait-sub">Moder√°tor brzy spust√≠ kv√≠z‚Ä¶</div>
</div>

<!-- QUESTION -->
<div class="scr" id="s-q">
  <div class="q-topbar">
    <div>
      <div class="q-num-lbl" id="q-num">Ot√°zka 1/5</div>
    </div>
    <div class="q-tbar-wrap"><div class="q-tbar" id="q-tbar"></div></div>
    <div class="q-timer-face" id="q-tface">30</div>
  </div>
  <div class="q-body">
    <div class="q-text" id="q-text">Naƒç√≠t√°m‚Ä¶</div>
    <div class="closed-banner" id="closed-banner">üîí Odpov√≠d√°n√≠ bylo uzav≈ôeno</div>
    <div class="opts" id="opts"></div>
  </div>
</div>

<!-- INTER RESULT -->
<div class="scr" id="s-res">
  <div class="res-icon" id="r-icon">‚úÖ</div>
  <div class="res-msg" id="r-msg">Spr√°vnƒõ!</div>
  <div class="res-ans-box">
    <div class="res-ans-lbl">Spr√°vn√° odpovƒõƒè</div>
    <div class="res-ans-val" id="r-correct">‚Äì</div>
  </div>
  <div class="res-stats">
    <div class="rstat"><div class="rstat-val g" id="r-score">0</div><div class="rstat-lbl">Spr√°vnƒõ celkem</div></div>
    <div class="rstat"><div class="rstat-val" style="color:var(--muted)" id="r-total">0</div><div class="rstat-lbl">Zodpovƒõzeno</div></div>
  </div>
  <div class="wait-next">‚è≥ ƒåek√° se na dal≈°√≠ ot√°zku‚Ä¶</div>
</div>

<!-- FINAL -->
<div class="scr" id="s-final">
  <div class="final-hdr anim">
    <div class="final-medal" id="f-medal">üèÜ</div>
    <div class="final-rank" id="f-rank">#1</div>
    <div class="final-name" id="f-name"></div>
    <div class="final-score" id="f-score"></div>
  </div>
  <div class="lb-title" style="margin-bottom:8px">Celkov√© po≈ôad√≠</div>
  <div class="lb" id="f-lb"></div>
</div>

<script>
const OPTS=['A','B','C','D'];
const LC=['lA','lB','lC','lD'];
const MEDALS=['ü•á','ü•à','ü•â'];

let myName='', myCode='', playerKey='';
let myAnswers={}, myScore=0;
let lastQ=-1, lastTS=0;
let answered=false, lockedQ=-1;
let timerInt=null;
let pollInt=null;
let interShownFor=-1;

/* FIREBASE CONFIG */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBZsk77K9aRF-LHbLZdgrVhI4rEARykdaQ",
  authDomain: "quizlive-f87c1.firebaseapp.com",
  databaseURL: "https://quizlive-f87c1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "quizlive-f87c1",
  storageBucket: "quizlive-f87c1.firebasestorage.app",
  messagingSenderId: "343853762884",
  appId: "1:343853762884:web:e9e1fa3d462f4514b7af11",
  measurementId: "G-3RH67MN6LY"
};

/* STORAGE ‚Äì Firebase Realtime Database */
let _db = null;
async function getDB(){
  if(_db) return _db;
  const {initializeApp} = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js");
  const {getDatabase} = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js");
  const app = initializeApp(FIREBASE_CONFIG, 'quizlive');
  _db = getDatabase(app);
  return _db;
}
function keyToPath(k){ return k.replace(/:/g,'/') }
async function sg(k){
  try{
    const {ref,get} = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js");
    const db = await getDB();
    const snap = await get(ref(db, keyToPath(k)));
    return snap.exists() ? snap.val() : null;
  }catch(e){console.error('sg',e);return null}
}
async function ss(k,v){
  try{
    const {ref,set} = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js");
    const db = await getDB();
    await set(ref(db, keyToPath(k)), v);
  }catch(e){console.error('ss',e)}
}
async function sl(prefix){
  try{
    const {ref,get} = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js");
    const db = await getDB();
    const path = prefix.replace(/:$/,'').replace(/:/g,'/');
    const snap = await get(ref(db, path));
    if(!snap.exists()) return [];
    const keys = [];
    snap.forEach(child => { keys.push(prefix + child.key); });
    return keys;
  }catch(e){console.error('sl',e);return[]}
}

/* AUTO-FILL CODE FROM URL */
window.addEventListener('load',()=>{
  const params=new URLSearchParams(location.search);
  const c=params.get('code');
  if(c){document.getElementById('inp-code').value=c.toUpperCase()}
});
document.getElementById('inp-code').addEventListener('input',function(){this.value=this.value.toUpperCase()});

/* JOIN */
async function joinQuiz(){
  const code=document.getElementById('inp-code').value.trim().toUpperCase();
  const name=document.getElementById('inp-name').value.trim();
  if(code.length<4||!name){showErr('Vypl≈à k√≥d i jm√©no.');return}
  const ses=await sg('session:'+code);
  if(!ses||ses.phase==='results'){showErr('M√≠stnost nenalezena nebo kv√≠z skonƒçil.');return}
  myName=name; myCode=code;
  playerKey='player:'+code+':'+name.toLowerCase().replace(/\s+/g,'_')+'_'+Date.now();
  await ss(playerKey,{name:myName,code:myCode,joinedAt:Date.now(),answers:{},score:0});
  document.getElementById('w-name').textContent=myName;
  showScr('wait');
  pollInt=setInterval(checkSes,1100);
}
function showErr(msg){const e=document.getElementById('j-err');e.textContent=msg;e.style.display='block'}

/* POLL */
async function checkSes(){
  const ses=await sg('session:'+myCode);
  if(!ses)return;

  if(ses.phase==='results'){
    clearInterval(pollInt);
    await showFinal();return;
  }

  if(ses.phase==='question'){
    const qi=ses.currentQ;

    // Answers closed ‚Üí show banner
    if(!ses.answersOpen&&qi===lastQ&&answered&&interShownFor!==qi){
      document.getElementById('closed-banner').classList.add('show');
    }
    // Revealed ‚Üí show inter result
    if(ses.revealed&&qi===lastQ&&answered&&interShownFor!==qi){
      showInterResult(ses.question,qi);return;
    }
    // Answers closed but not answered yet ‚Üí lock
    if(!ses.answersOpen&&qi===lastQ&&!answered&&lockedQ!==qi){
      lockedQ=qi;lockAnswers();
      document.getElementById('closed-banner').classList.add('show');
    }
    // New question
    if(qi!==lastQ&&ses.ts!==lastTS){
      lastQ=qi;lastTS=ses.ts;answered=false;lockedQ=-1;
      clearInterval(timerInt);
      showScr('q');renderQ(ses.question,qi,ses.questionCount);
    }
  }
}

/* RENDER QUESTION */
function renderQ(q,idx,total){
  document.getElementById('q-num').textContent=`Ot√°zka ${idx+1}/${total}`;
  document.getElementById('q-text').textContent=q.text;
  document.getElementById('closed-banner').classList.remove('show');
  const opts=document.getElementById('opts');
  opts.innerHTML=q.options.map((o,j)=>`
    <div class="opt anim" id="po-${j}" style="animation-delay:${j*.06}s" onclick="pickAns(${j})">
      <div class="opt-letter ${LC[j]}">${OPTS[j]}</div>
      <div class="opt-txt">${esc(o)}</div>
    </div>`).join('');
  if(q.time){showTick(q.time);startTick(q.time);}else showManualTick();
}

let _tickMax=30;
function showTick(s){_tickMax=s;const tf=document.getElementById('q-tface');tf.className='q-timer-face';tf.textContent=s;document.getElementById('q-tbar').style.width='100%'}
function showManualTick(){clearInterval(timerInt);const tf=document.getElementById('q-tface');tf.className='q-timer-face manual';tf.textContent='Ruƒçn√≠';document.getElementById('q-tbar').style.width='100%'}
function startTick(s){
  clearInterval(timerInt);let left=s;
  timerInt=setInterval(()=>{left--;document.getElementById('q-tface').textContent=left;document.getElementById('q-tbar').style.width=(left/s*100)+'%';if(left<=0){clearInterval(timerInt);if(!answered){answered=true;myAnswers[lastQ]=-1;savePlayer();lockAnswers();document.getElementById('closed-banner').classList.add('show');}}},1000);
}

function pickAns(j){
  if(answered||lockedQ===lastQ)return;
  answered=true;
  myAnswers[lastQ]=j;
  savePlayer();
  document.querySelectorAll('.opt').forEach((el,i)=>{el.classList.add('locked');if(i===j)el.classList.add('chosen')});
}
function lockAnswers(){
  document.querySelectorAll('.opt').forEach(el=>el.classList.add('locked'));
}

async function savePlayer(){
  await ss(playerKey,{name:myName,code:myCode,joinedAt:Date.now(),answers:myAnswers,score:myScore});
}

/* INTER RESULT */
let interShownQ=-1;
function showInterResult(q,qi){
  if(interShownFor===qi)return;
  interShownFor=qi;
  clearInterval(timerInt);

  // reveal on question screen first
  const myAns=myAnswers[qi];
  const ok=myAns===q.correct&&myAns!==undefined&&myAns!==-1;
  const noAns=myAns===undefined||myAns===-1;

  document.querySelectorAll('.opt').forEach((el,i)=>{
    el.classList.add('locked');el.classList.remove('chosen');
    if(i===q.correct)el.classList.add('correct');
    else if(i===myAns)el.classList.add('wrong');
  });

  if(ok)myScore++;

  setTimeout(()=>{
    document.getElementById('r-icon').textContent=noAns?'‚è±':ok?'‚úÖ':'‚ùå';
    document.getElementById('r-msg').textContent=noAns?'ƒåas vypr≈°el!':ok?'Spr√°vnƒõ!':'≈†patnƒõ!';
    document.getElementById('r-correct').textContent=OPTS[q.correct]+': '+q.options[q.correct];
    document.getElementById('r-score').textContent=myScore;
    document.getElementById('r-total').textContent=qi+1;
    showScr('res');
  },1000);
}

/* FINAL */
async function showFinal(){
  showScr('final');
  const keys=await sl('player:'+myCode+':');
  const players=[];
  for(const k of keys){const p=await sg(k);if(p)players.push(p);}
  const ranked=players.map(p=>({...p,ds:p.score||0})).sort((a,b)=>b.ds-a.ds);
  const myRank=ranked.findIndex(p=>p.name===myName)+1;
  document.getElementById('f-medal').textContent=MEDALS[myRank-1]||'üéâ';
  document.getElementById('f-rank').textContent='#'+myRank;
  document.getElementById('f-name').textContent=myName;
  document.getElementById('f-score').textContent=myScore+' spr√°vn√Ωch odpovƒõd√≠';
  document.getElementById('f-lb').innerHTML=ranked.map((p,i)=>`
    <div class="lbr${p.name===myName?' me':''}">
      <div class="lbrank${i<3?' top':''}">${i+1}</div>
      <div class="lbname">${esc(p.name)}${p.name===myName?' üëà':''}</div>
      <div class="lbscore">${p.score||0}</div>
    </div>`).join('');
}

/* UI */
function showScr(n){document.querySelectorAll('.scr').forEach(s=>s.classList.remove('active'));document.getElementById('s-'+n).classList.add('active')}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
</script>
</body>
</html>
